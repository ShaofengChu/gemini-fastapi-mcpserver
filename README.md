# Gemini Function Calling with FastAPI

This project is a simple demonstration of how to build a server that uses Google Gemini's function calling capabilities. It uses FastAPI as the web framework and the `google-generativeai` Python SDK.

## Overview

The server exposes a single API endpoint (`/command`) that accepts a natural language command from a user. The command is sent to the Gemini model, which can decide to call a predefined "tool" (a Python function) to get more information. In this example, the tool is `get_current_weather`. The tool's output is then sent back to the model, which generates a final, human-readable response.

## Features

-   **FastAPI Backend**: A modern, fast web framework for building APIs.
-   **Google Gemini Integration**: Leverages the `gemini-1.5-flash-latest` model for its function calling abilities.
-   **Tool Definition**: A clear example of how to define and provide a Python function as a tool for the LLM.
-   **OAuth2 JWT Authentication**: Secures endpoints using bearer tokens.
-   **Environment Variable Management**: Securely manages API keys using a `.env` file.

## Prerequisites

-   Python 3.8+
-   An active Google AI Studio API Key.

## Setup and Installation

1.  **Clone the repository:**
    ```bash
    git clone https://github.com/ShaofengChu/gemini-fastapi-mcpserver.git
    cd gemini-fastapi-mcpserver
    ```

2.  **Create and activate a virtual environment (recommended):**
    ```bash
    # Create a virtual environment
    python -m venv venv
    ```

    Activate the virtual environment:
    -   **On Windows:**
        ```bash
        .\venv\Scripts\activate
        ```
    -   **On macOS/Linux:**
        ```bash
        source venv/bin/activate
        ```

    > **Note for Debian/Ubuntu users:** If you get an error about `ensurepip`, you may need to install the `venv` package for your Python version (e.g., `sudo apt install python3-venv`).


3.  **Install the required packages:** 
    ```bash
    pip install -r requirements.txt
    ```

4.  **Set up your environment variables:**
    Create a file named `.env` in the root directory of the project. You will need to add your Google API key and a secret key for signing JWTs.

    You can generate a secure secret key with `openssl rand -hex 32`.

    ```ini
    GOOGLE_API_KEY="your_google_api_key"
    SECRET_KEY="your_generated_32_byte_hex_string"
    ```

## Running the Server

Start the FastAPI server using `uvicorn`:

```bash
uvicorn main:app --reload
```

The server will be running at `http://127.0.0.1:8000`. You can access the auto-generated API documentation at `http://127.0.0.1:8000/docs`.

## Usage

You can interact with the API via the auto-generated documentation at `http://127.0.0.1:8000/docs` or using a tool like `curl`.

### 1. Get an Authentication Token

First, get a JWT access token by sending the sample credentials (`testuser`:`password`) to the `/token` endpoint.

**Request:**
```bash
curl -X POST "http://127.0.0.1:8000/token" \
-H "Content-Type: application/x-www-form-urlencoded" \
-d "username=testuser&password=password"
```

### Expected Response

The server will respond with the final text generated by Gemini after calling the weather tool. The exact wording may vary.

```json
{
  "status": "success",
  "response": "The current weather in 上海 is 25 degrees Celsius and clear."
}
```

## 在手机上进行完整认证流程测试的详细步骤：

### 1. 让服务器在局域网内可访问

你的电脑和手机需要连接到同一个 Wi-Fi 网络。默认情况下，uvicorn 运行在 127.0.0.1 上，这只允许本机访问。你需要让它监听 0.0.0.0，这样局域网内的其他设备（比如你的手机）才能访问它。

停止当前正在运行的服务器 (如果它在运行的话)。
使用以下命令重新启动服务器：
```bash
uvicorn main:app --reload --host 0.0.0.0
```
获取你电脑的局域网 IP 地址。
在 Windows 上: 打开命令提示符（cmd）并输入 ipconfig，查找 "无线局域网适配器 WLAN" 下的 "IPv4 地址"。它通常看起来像 192.168.1.x。
在 macOS 或 Linux 上: 打开终端并输入 ifconfig 或 ip a，查找 wlan0 或 en0 下的 inet 地址。

### 2. 在手机上进行测试

现在，拿起你的手机，确保它连接到与电脑相同的 Wi-Fi 网络。

1.**打开手机浏览器 (如 Chrome, Safari 等)。**

2.**在地址栏输入 http://<你电脑的IP地址>:8000/docs。例如：http://192.168.1.5:8000/docs。你应该能看到 Swagger UI 界面。**

3.**获取认证 Token：**

向下滚动找到 POST /token 接口，点击它展开。
点击右上角的 "Try it out" 按钮。
在下方的 Request body 中，输入用户名 testuser 和密码 password。
点击蓝色的 "Execute" 按钮。
向下滚动到 "Server response" 部分，你会看到一个成功的响应。长按并复制 access_token 的值（那一长串以 eyJ... 开头的字符串）。

4.**授权你的会话：**
滚动到页面顶部，点击绿色的 "Authorize" 按钮。
在弹出的 "Available authorizations" 窗口中，将你刚刚复制的 access_token 粘贴到 "Value" 输入框里。
点击 "Authorize"，然后点击 "Close" 关闭弹窗。你会发现 "Authorize" 按钮上的锁形图标现在是闭合状态，表示你已登录。

5.**测试受保护的接口：**
现在向下滚动到 POST /command 接口，点击它展开。
点击 "Try it out"。
在 Request body 的编辑框中，输入你的指令，例如：
json
{
  "user_command": "上海今天天气怎么样？"
}
点击 "Execute" 按钮。
这次请求将会成功，因为 Swagger UI 会自动在请求头中附带你刚才设置的 Bearer Token。你会在下方看到一个 200 OK 的成功响应，其中包含了 Gemini 的回答。

通过以上步骤，你就可以完全在手机上模拟客户端的整个认证和请求流程了。